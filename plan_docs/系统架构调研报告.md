# 穿搭推荐系统 - 架构调研报告

**日期**: 2026年1月14日  
**调研范围**: 微服务架构、缓存策略、跨平台框架、数据存储方案

---

## 目录

1. [后端架构调研](#后端架构调研)
2. [前端与移动端调研](#前端与移动端调研)
3. [数据存储方案](#数据存储方案)
4. [商用许可对比](#商用许可对比)
5. [推荐方案](#推荐方案)

---

## 后端架构调研

### 1. gRPC 微服务通信方案

#### 核心优势
- **高性能**: 基于 HTTP/2 和 Protocol Buffers，提供高效的二进制序列化和多路复用
- **跨语言支持**: 支持 Java、Go、Python、C++、Node.js 等多种编程语言
- **双向流**: 适合穿搭推荐、试衣等实时数据传输场景
- **可观测性**: 内置 channelz 和 telemetry 系统

#### 商用许可
- **许可证**: Apache 2.0（完全开源）
- **商用限制**: 无，可自由用于商业产品
- **支持**: 开源社区支持

#### 应用场景
```
用户服务 <--> 推荐引擎 (gRPC)
试衣服务 <--> AR处理服务 (gRPC Streaming)
用户数据库 <--> 缓存层 (gRPC)
```

#### 推荐配置
```protobuf
service RecommendationService {
  rpc GetOutfitRecommendations(UserProfile) returns (OutfitList);
  rpc StreamVirtualTryOn(stream TryOnRequest) returns (stream TryOnResponse);
}
```

---

### 2. Kafka 消息队列方案

#### 核心特性
- **高吞吐量**: 每秒处理数百万条消息
- **容错性**: 多副本和分区机制确保数据安全
- **实时性**: 支持流处理和实时分析

#### 商用许可
- **许可证**: Apache License 2.0（开源）
- **商用限制**: 无限制
- **第三方依赖**: Jersey (CDDL), Jackson (Apache 2.0)

#### 穿搭推荐系统应用
```
消息主题设计:
- user-actions: 用户穿搭行为
- try-on-results: 虚拟试衣结果
- recommendation-events: 推荐事件
- inventory-updates: 衣物库存更新
```

#### 高并发处理
```
推荐请求 --> Kafka (Buffer)
  |-> 推荐引擎消费
  |-> 实时个性化处理
  |-> 试衣任务队列
```

---

### 3. Redis 缓存策略

#### 商用许可演变
| 版本 | 许可证 | 商用限制 |
|------|--------|---------|
| Redis 7.2 及以前 | BSD v3 | 无限制 |
| Redis 8+ | RSALv2/SSPLv1/AGPLv3 | 有限制 |

#### 高并发推荐缓存方案

**缓存策略**:
```
1. 热点用户推荐缓存
   - Key: user:{userId}:recommendations
   - TTL: 30分钟
   - 淘汰策略: allkeys-lru

2. 衣物搭配缓存
   - Key: outfit:{outfitId}:details
   - TTL: 1小时
   - 淘汰策略: allkeys-lru

3. AR试衣结果缓存
   - Key: tryOn:{sessionId}:results
   - TTL: 12小时
   - 淘汰策略: volatile-lru
```

**配置示例**:
```redis
maxmemory 4gb
maxmemory-policy allkeys-lru
maxmemory-samples 5
maxclients 10000
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
```

**性能优化**:
- 客户端侧缓存降低延迟
- 惰性释放避免阻塞主线程
- 高可用方案: Redis Sentinel + Redis Cluster

---

## 前端与移动端调研

### 1. React Native - AR 组件集成

#### 许可证
- **开源许可**: MIT（完全自由）
- **商用使用**: 无任何限制

#### AR 集成方案

**原生模块集成流程**:
1. 定义 JavaScript 规范（Flow/TypeScript）
2. React Native Codegen 生成原生代码接口
3. iOS 实现原生视图
4. 通过 CocoaPods 集成依赖

**关键配置**:
```javascript
// JavaScript 规范
import { codegenNativeComponent } from 'react-native/Libraries/Utilities/codegenNativeComponent';

const NativeARComponent = codegenNativeComponent('ARComponent');

export default NativeARComponent;
```

**CocoaPods 集成**:
```ruby
use_react_native!
react_native_post_install(installer)
```

#### AR 框架推荐
- ARCore (Android)
- ARKit (iOS)
- 通过平台通道调用

---

### 2. Flutter - AR 组件集成

#### 许可证
- **开源许可**: BSD（完全自由）
- **商用使用**: 无任何限制

#### AR 集成方案

**许可证管理**:
```dart
void addLicenses() {
  LicenseRegistry.addLicense(() async* {
    final license = await rootBundle.loadString('assets/licenses/ar_sdk.txt');
    yield LicenseEntryWithLineBreaks(['ARCore SDK'], license);
  });
}
```

**平台通道集成**:
```dart
// Dart 侧
static const platform = MethodChannel('com.example.fashion/ar');

Future<String> initARSession() async {
  return await platform.invokeMethod('initAR');
}
```

**注意**: Flutter 不原生支持 AR，需通过第三方 SDK（ARCore/ARKit）和平台通道集成

---

### 3. 图片上传与视频流处理

#### WebGL 加速优化方案
- **图片处理**: 在 GPU 上进行滤镜、缩放、色彩处理
- **视频流**: 硬件加速解码和渲染
- **性能提升**: 相比 CPU 处理提升 10-100 倍

#### 前端优化建议
```javascript
// WebGL 图片处理示例
const canvas = document.createElement('canvas');
const gl = canvas.getContext('webgl2');

// 使用 WebGL 进行实时图片处理
// - 降噪、增强
// - 色彩空间转换
// - 人脸检测优化
```

---

## 数据存储方案

### 1. Neo4j 图数据库

#### 商用许可
| 版本 | 许可证 | 商用适用 |
|------|--------|---------|
| 社区版 | GPL v3.0 | 需合规评估 |
| 企业版 | 商业许可 | 推荐用于商用 |

#### 复杂关系查询优化

**穿搭推荐关系模型**:
```cypher
// 用户-衣物-搭配关系
MATCH (user:User)-[:LIKED]->(outfit:Outfit)-[:CONTAINS]->(item:Item)
WHERE user.id = $userId
RETURN outfit, item

// 相似用户推荐
MATCH (user1:User)-[:LIKED]->(o:Outfit)<-[:LIKED]-(user2:User)
WHERE user1.id = $userId AND user1 <> user2
WITH user2, COUNT(o) as similarity
RETURN user2 ORDER BY similarity DESC LIMIT 10
```

**路径模式优化技术**:
- Trail 到 VarExpand 转换
- 剪枝可变长度扩展
- BFS 最短路径优化
- 有状态最短路径算法

#### 成本考虑
- **社区版**: 0 元（需符合 GPL v3）
- **企业版**: 商业许可（按节点/年付费）

---

### 2. 对象存储方案对比

#### AWS S3

**商用许可**: 商业许可（按使用付费）

**特性**:
- 无限容量
- 99.99% 可用性
- 服务器端加密
- 灵活的生命周期管理

**成本模型**:
```
存储: $0.023/GB/月 (标准存储)
请求: $0.0004/1000 GET 请求
      $0.005/1000 PUT 请求
传出流量: $0.09/GB
```

**穿搭系统估算**:
- 每日 10 万用户，每用户 50 张图片 = 500 万张
- 平均 2MB/张 = 10 TB
- 月成本: $230 (存储) + 约 $100 (请求/流量) = **$330/月**

---

#### MinIO (自建)

**商用许可**:
- **社区版**: GNU AGPL v3.0（修改代码需开源）
- **企业版 AIStor**: 商业许可（推荐生产环境）

**特性**:
- S3 兼容 API
- 高吞吐量 (TB/s 级别)
- 纠删码冗余 (N/2)
- 分布式部署

**架构分层**:
```
Layer 1: 客户端接口 (S3 SDK, Web UI, CLI)
Layer 2: API 网关 (路由、认证)
Layer 3: 安全与身份 (IAM, STS)
Layer 4: 存储抽象 (纠删码、分发)
Layer 5: 磁盘操作 (本地/远程 I/O)
Layer 6: 后台服务 (扫描、生命周期、复制)
```

**自建成本**:
- 硬件: 16 个 8TB 磁盘 = $4000 (一次性)
- 带宽: 100Mbps = $300/月
- 维护: 人力成本
- **总成本**: 初期投入 $4000 + 月运维

#### 阿里云 OSS

**商用许可**: 商业许可（按使用付费）

**特性**:
- 国内访问延迟低
- 99.99% 可用性
- 国内合规存储
- 原生集成 CDN

**成本模型**:
```
存储: ¥0.12/GB/月
请求: ¥0.01/万次
下载: ¥0.5/GB (超出免费额度)
```

---

### 3. 存储方案成本对比

| 方案 | 初期投入 | 月成本 | 适用场景 |
|------|---------|--------|---------|
| AWS S3 | 0 | $330-500 | 全球访问，无运维 |
| 阿里云 OSS | 0 | ¥600-1000 | 国内主要市场 |
| MinIO 社区版 | $4000 | $500-800 | 自建，需开源代码 |
| MinIO 企业版 | $4000 | $1000-1500 | 生产级，企业级支持 |

---

## 商用许可对比

### 完整许可证汇总

| 技术栈 | 许可证 | 商用限制 | 推荐度 |
|--------|--------|---------|--------|
| **gRPC** | Apache 2.0 | ✅ 无 | ⭐⭐⭐⭐⭐ |
| **Kafka** | Apache 2.0 | ✅ 无 | ⭐⭐⭐⭐⭐ |
| **Redis ≤7.2** | BSD v3 | ✅ 无 | ⭐⭐⭐⭐⭐ |
| **Redis ≥8** | RSALv2 | ⚠️ 有限制 | ⭐⭐⭐⭐ |
| **React Native** | MIT | ✅ 无 | ⭐⭐⭐⭐⭐ |
| **Flutter** | BSD | ✅ 无 | ⭐⭐⭐⭐⭐ |
| **Neo4j 社区版** | GPL v3.0 | ⚠️ 需合规 | ⭐⭐⭐ |
| **Neo4j 企业版** | 商业许可 | ✅ 无 | ⭐⭐⭐⭐ |
| **MinIO 社区版** | AGPL v3.0 | ⚠️ 需开源 | ⭐⭐⭐ |
| **MinIO 企业版** | 商业许可 | ✅ 无 | ⭐⭐⭐⭐⭐ |
| **AWS S3** | AWS 商业许可 | ✅ 无 | ⭐⭐⭐⭐ |
| **阿里云 OSS** | 阿里商业许可 | ✅ 无 | ⭐⭐⭐⭐ |

---

## 推荐方案

### 分层推荐架构

```
┌─────────────────────────────────────────────────────────┐
│                   前端层                                 │
│  React Native (iOS/Android) + Flutter 跨平台             │
│  WebGL 加速图片处理、AR 组件集成                         │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                   API 网关                               │
│  gRPC (内部服务通信) + REST (外部 API)                  │
│  负载均衡、限流、认证                                   │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│              微服务化后端架构                            │
├─────────────────────────────────────────────────────────┤
│ 1. 推荐引擎服务                                         │
│    - 基于 Neo4j 的复杂关系查询                          │
│    - Redis 缓存热点推荐结果                             │
│                                                          │
│ 2. 虚拟试衣服务                                         │
│    - AR 处理服务（Java/Python）                        │
│    - Kafka 异步任务队列                                 │
│                                                          │
│ 3. 用户管理服务                                         │
│    - 用户档案、偏好设置                                 │
│    - gRPC 高效通信                                      │
│                                                          │
│ 4. 库存服务                                             │
│    - 衣物信息、库存管理                                 │
│    - Kafka 事件驱动                                     │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                 缓存层                                   │
│  Redis Cluster (集群模式)                                │
│  - 推荐结果缓存 (TTL 30 分钟)                           │
│  - 用户会话缓存 (TTL 24 小时)                           │
│  - AR 试衣结果缓存 (TTL 12 小时)                        │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                 数据存储层                               │
├─────────────────────────────────────────────────────────┤
│ 1. Neo4j (企业版)                                        │
│    - 用户-衣物-搭配关系图                               │
│    - 支持复杂推荐算法                                   │
│                                                          │
│ 2. PostgreSQL / MySQL                                   │
│    - 用户账户、交易数据                                 │
│    - 事务一致性强                                       │
│                                                          │
│ 3. MinIO (企业版) / AWS S3                              │
│    - 用户上传衣物图片                                   │
│    - AR 处理结果存储                                    │
│    - 推荐效果图存储                                     │
│                                                          │
│ 4. Kafka (消息日志)                                     │
│    - 用户行为事件溯源                                   │
│    - 推荐算法训练数据                                   │
└─────────────────────────────────────────────────────────┘
```

### 具体实施建议

#### 第一阶段（MVP）
1. **后端**: gRPC + Kafka + Redis + PostgreSQL
2. **前端**: React Native + 简单 AR 预览
3. **存储**: MinIO 自建（初期低成本）
4. **许可**: 所有开源组件（Apache 2.0 / BSD）

#### 第二阶段（商用上线）
1. **数据库升级**: 部署 Neo4j 企业版
2. **存储升级**: 考虑 AWS S3 或阿里云 OSS（高可用）
3. **中间件升级**: Redis 7.2（避免商用许可问题）
4. **AR 增强**: 集成完整 ARCore/ARKit

#### 第三阶段（规模化）
1. **地域部署**: 多区域 Kafka 集群
2. **实时处理**: Flink/Spark Streaming
3. **推荐优化**: 深度学习模型集成
4. **全球化**: CDN + 多云存储

---

## 许可合规检查清单

- [x] **gRPC** - Apache 2.0 ✅ 可商用
- [x] **Kafka** - Apache 2.0 ✅ 可商用
- [x] **Redis ≤7.2** - BSD v3 ✅ 可商用
- [ ] **Redis ≥8** - ⚠️ 评估 RSALv2 限制
- [x] **React Native** - MIT ✅ 可商用
- [x] **Flutter** - BSD ✅ 可商用
- [ ] **Neo4j** - ⚠️ 社区版需评估，建议企业版
- [ ] **MinIO** - ⚠️ 社区版需开源代码，建议企业版
- [x] **AWS S3** - AWS 许可 ✅ 可商用
- [x] **阿里云 OSS** - 阿里许可 ✅ 可商用

---

## 参考资源

### GitHub 仓库
- [gRPC](https://github.com/grpc/grpc)
- [Apache Kafka](https://github.com/apache/kafka)
- [Redis](https://github.com/redis/redis)
- [React Native](https://github.com/facebook/react-native)
- [Flutter](https://github.com/flutter/flutter)
- [Neo4j](https://github.com/neo4j/neo4j)
- [MinIO](https://github.com/minio/minio)

### 许可证资源
- [Apache License 2.0](https://www.apache.org/licenses/LICENSE-2.0)
- [BSD 3-Clause License](https://opensource.org/licenses/BSD-3-Clause)
- [MIT License](https://opensource.org/licenses/MIT)
- [GPL v3.0](https://www.gnu.org/licenses/gpl-3.0.html)
- [AGPL v3.0](https://www.gnu.org/licenses/agpl-3.0.html)

---

**文档版本**: 1.0  
**最后更新**: 2026-01-14  
**维护者**: 架构团队
